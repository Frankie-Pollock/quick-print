<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OCR PDF Test</title>
</head>
<body>
    <h2>OCR Test (First Page of PDF)</h2>

    <input type="file" id="pdfInput" accept="application/pdf">
    <p id="status"></p>
    <p id="result"></p>

    <canvas id="pdfCanvas" style="display:none;"></canvas>

    <!-- Load Tesseract UMD build -->
    <script src="./libs/tesseract/tesseract.min.js"></script>

    <!-- Use ES module only for PDF.js -->
    <script type="module">
        import * as pdfjsLib from "./libs/pdfjs/pdf.min.mjs";
        pdfjsLib.GlobalWorkerOptions.workerSrc = "./libs/pdfjs/pdf.worker.min.mjs";

        const status = document.getElementById("status");
        const result = document.getElementById("result");
        const pdfCanvas = document.getElementById("pdfCanvas");

        document.getElementById("pdfInput").addEventListener("change", async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            status.textContent = "Loading PDF...";
            result.textContent = "";

            const arrayBuffer = await file.arrayBuffer();

            // Load PDF
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            // Render page 1
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 1.5 });
            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;

            await page.render({
                canvasContext: pdfCanvas.getContext("2d"),
                viewport
            }).promise;

            status.textContent = "Running OCR...";

            /* ---------------------------
                TESSERACT (UMD interface)
               --------------------------- */
            const { createWorker } = Tesseract;

            const worker = await createWorker({
                workerPath: "./libs/tesseract/worker.min.js",
                corePath: "./libs/tesseract/tesseract-core.wasm.js",
                langPath: "./libs/tesseract/lang-data/",
                logger: m => {
                    status.textContent = "OCR Progress: " + Math.round(m.progress * 100) + "%";
                }
            });

            await worker.loadLanguage('eng');
            await worker.initialize('eng');

            const { data } = await worker.recognize(pdfCanvas);

            await worker.terminate();

            const firstWords = data.text.split(/\s+/).slice(0, 20).join(" ");

            status.textContent = "OCR Complete.";
            result.textContent = "First OCR words: " + firstWords;
        });
    </script>

</body>
</html>
