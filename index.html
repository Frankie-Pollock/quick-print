<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OCR PDF Test</title>
</head>
<body>
    <h2>OCR Test (First Page of PDF)</h2>

    <input type="file" id="pdfInput" accept="application/pdf">
    <p id="status"></p>
    <p id="result"></p>

    <canvas id="pdfCanvas" style="display:none;"></canvas>

    <script type="module">
        /* -------------------------------------------------------
           Load local PDF.js
        --------------------------------------------------------- */
        import * as pdfjsLib from "./libs/pdfjs/pdf.min.mjs";
        pdfjsLib.GlobalWorkerOptions.workerSrc = "./libs/pdfjs/pdf.worker.min.mjs";

        /* -------------------------------------------------------
           Load local Tesseract.js
        --------------------------------------------------------- */
        import Tesseract from "./libs/tesseract/tesseract.min.js";

        const status = document.getElementById("status");
        const result = document.getElementById("result");
        const pdfCanvas = document.getElementById("pdfCanvas");

        document.getElementById("pdfInput").addEventListener("change", async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            status.textContent = "Loading PDF...";
            result.textContent = "";

            const arrayBuffer = await file.arrayBuffer();

            // Load the PDF
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            // Get page 1
            const page = await pdf.getPage(1);

            // Render to canvas (scale = 1.5)
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = pdfCanvas;
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: context, viewport }).promise;

            status.textContent = "Running OCR...";

            /* -------------------------------------------------------
               Tesseract OCR Worker (offline)
            --------------------------------------------------------- */
            const worker = await Tesseract.createWorker({
                workerPath: "./libs/tesseract/worker.min.js",
                corePath: "./libs/tesseract/tesseract-core.wasm.js",
                langPath: "./libs/tesseract/lang-data/",
                logger: m => {
                    status.textContent = "OCR Progress: " + Math.round(m.progress * 100) + "%";
                }
            });

            await worker.loadLanguage('eng');
            await worker.initialize('eng');

            const { data } = await worker.recognize(canvas);

            await worker.terminate();

            const firstWords = data.text.split(/\s+/).slice(0, 20).join(" ");

            status.textContent = "OCR Complete.";
            result.textContent = "First OCR words: " + firstWords;
        });
    </script>

</body>
</html>
